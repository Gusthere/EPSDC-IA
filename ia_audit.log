2025-11-16 22:40:40,306 [INFO] Inicio de ETL de features_parroquia_daily
2025-11-16 22:40:40,400 [ERROR] Error en ETL: (pymysql.err.OperationalError) (1054, "Unknown column 'p.id_parroquia' in 'field list'")
[SQL: -- V1.0
-- -- features_diarias.sql
-- INSERT INTO features_parroquia_daily (
--     parroquia_id,
--     fecha,
--     consumo_7d,
--     consumo_30d,
--     promedio_12m,
--     dias_desde_ultima_entrega,
--     stock_actual,
--     stock_minimo,
--     entregas_pendientes,
--     proyeccion_72h,
--     indicador_riesgo,
--     calidad_datos
-- )
-- SELECT 
--     p.id AS parroquia_id,
--     CURDATE() AS fecha,

--     -- Total entregado últimos 7 días
--     COALESCE((
--         SELECT SUM(e.cantidad_entregada)
--         FROM entrega e
--         WHERE e.parroquia_id = p.id
--           AND e.fecha_entrega BETWEEN CURDATE() - INTERVAL 7 DAY AND CURDATE()
--     ), 0) AS consumo_7d,

--     -- Total entregado últimos 30 días
--     COALESCE((
--         SELECT SUM(e.cantidad_entregada)
--         FROM entrega e
--         WHERE e.parroquia_id = p.id
--           AND e.fecha_entrega BETWEEN CURDATE() - INTERVAL 30 DAY AND CURDATE()
--     ), 0) AS consumo_30d,

--     -- Promedio mensual de los últimos 12 meses
--     COALESCE((
--         SELECT SUM(e.cantidad_entregada) / 12
--         FROM entrega e
--         WHERE e.parroquia_id = p.id
--           AND e.fecha_entrega BETWEEN CURDATE() - INTERVAL 12 MONTH AND CURDATE()
--     ), 0) AS promedio_12m,

--     -- Días desde la última entrega
--     DATEDIFF(
--         CURDATE(),
--         COALESCE(
--             (SELECT MAX(e.fecha_entrega)
--              FROM entrega e
--              WHERE e.parroquia_id = p.id),
--             CURDATE()
--         )
--     ) AS dias_desde_ultima_entrega,

--     -- Stock actual y mínimo
--     COALESCE(a.stock_actual, 0) AS stock_actual,
--     COALESCE(a.stock_minimo, 0) AS stock_minimo,

--     -- Solicitudes pendientes
--     (
--         SELECT COUNT(*)
--         FROM solicitud s
--         WHERE s.parroquia_id = p.id
--           AND s.estado IN ('pendiente', 'en_proceso')
--     ) AS entregas_pendientes,

--     -- Proyección simple de consumo a 3 días
--     ROUND(
--         (COALESCE((
--             SELECT SUM(e.cantidad_entregada)
--             FROM entrega e
--             WHERE e.parroquia_id = p.id
--               AND e.fecha_entrega BETWEEN CURDATE() - INTERVAL 7 DAY AND CURDATE()
--         ), 0) / 7) * 3,
--         2
--     ) AS proyeccion_72h,

--     -- Indicador de riesgo: stock / consumo semanal
--     CASE 
--         WHEN COALESCE((
--             SELECT SUM(e.cantidad_entregada)
--             FROM entrega e
--             WHERE e.parroquia_id = p.id
--               AND e.fecha_entrega BETWEEN CURDATE() - INTERVAL 7 DAY AND CURDATE()
--         ), 0) = 0 THEN 0
--         ELSE ROUND(
--             a.stock_actual / (
--                 COALESCE((
--                     SELECT SUM(e.cantidad_entregada)
--                     FROM entrega e
--                     WHERE e.parroquia_id = p.id
--                       AND e.fecha_entrega BETWEEN CURDATE() - INTERVAL 7 DAY AND CURDATE()
--                 ), 1)
--             ), 2)
--     END AS indicador_riesgo,

--     -- Calidad de datos básica
--     CASE 
--         WHEN a.stock_actual IS NULL THEN 'MISSING_STOCK'
--         WHEN p.id IS NULL THEN 'NO_PARROQUIA'
--         ELSE 'OK'
--     END AS calidad_datos

-- FROM parroquia p
-- LEFT JOIN almacen a ON a.parroquia_id = p.id
-- ON DUPLICATE KEY UPDATE
--     consumo_7d = VALUES(consumo_7d),
--     consumo_30d = VALUES(consumo_30d),
--     promedio_12m = VALUES(promedio_12m),
--     dias_desde_ultima_entrega = VALUES(dias_desde_ultima_entrega),
--     stock_actual = VALUES(stock_actual),
--     stock_minimo = VALUES(stock_minimo),
--     entregas_pendientes = VALUES(entregas_pendientes),
--     proyeccion_72h = VALUES(proyeccion_72h),
--     indicador_riesgo = VALUES(indicador_riesgo),
--     calidad_datos = VALUES(calidad_datos),
--     updated_at = CURRENT_TIMESTAMP;
-- -- features_diarias.sql

-- V2.0
-- features_diarias.sql
INSERT INTO features_parroquia_daily (
    parroquia,
    fecha,
    consumo_7d,
    consumo_30d,
    promedio_12m,
    dias_desde_ultima_entrega,
    stock_actual,
    stock_capacidad,
    solicitudes_pendientes,
    proyeccion_72h,
    indicador_riesgo,
    calidad_datos
)
SELECT 
    p.id_parroquia AS parroquia,
    CURDATE() AS fecha,

    -- Total entregado últimos 7 días
    COALESCE((
        SELECT SUM(e.cantidad)
        FROM entrega e
        WHERE e.parroquia = p.id_parroquia
          AND e.fecha_entrega BETWEEN CURDATE() - INTERVAL 7 DAY AND CURDATE()
    ), 0) AS consumo_7d,

    -- Total entregado últimos 30 días
    COALESCE((
        SELECT SUM(e.cantidad)
        FROM entrega e
        WHERE e.parroquia = p.id_parroquia
          AND e.fecha_entrega BETWEEN CURDATE() - INTERVAL 30 DAY AND CURDATE()
    ), 0) AS consumo_30d,

    -- Promedio mensual de los últimos 12 meses
    COALESCE((
        SELECT SUM(e.cantidad) / 12
        FROM entrega e
        WHERE e.parroquia = p.id_parroquia
          AND e.fecha_entrega BETWEEN CURDATE() - INTERVAL 12 MONTH AND CURDATE()
    ), 0) AS promedio_12m,

    -- Días desde la última entrega
    DATEDIFF(
        CURDATE(),
        COALESCE(
            (SELECT MAX(e.fecha_entrega)
             FROM entrega e
             WHERE e.parroquia = p.id_parroquia),
            CURDATE()
        )
    ) AS dias_desde_ultima_entrega,

    -- Stock actual y capacidad
    COALESCE(a.existencia, 0) AS stock_actual,
    COALESCE(a.capacidad, 0) AS stock_capacidad,

    -- Solicitudes pendientes
    (
        SELECT COUNT(*)
        FROM solicitud s
        WHERE s.parroquia = p.id_parroquia
          AND s.estado IN ('pendiente', 'en_proceso')
    ) AS solicitudes_pendientes,

    -- Proyección de consumo a 3 días (basada en promedio semanal)
    ROUND(
        (COALESCE((
            SELECT SUM(e.cantidad)
            FROM entrega e
            WHERE e.parroquia = p.id_parroquia
              AND e.fecha_entrega BETWEEN CURDATE() - INTERVAL 7 DAY AND CURDATE()
        ), 0) / 7) * 3,
        2
    ) AS proyeccion_72h,

    -- Indicador de riesgo (stock_actual / consumo semanal)
    CASE 
        WHEN COALESCE((
            SELECT SUM(e.cantidad)
            FROM entrega e
            WHERE e.parroquia = p.id_parroquia
              AND e.fecha_entrega BETWEEN CURDATE() - INTERVAL 7 DAY AND CURDATE()
        ), 0) = 0 THEN 0
        ELSE ROUND(
            a.existencia / (
                COALESCE((
                    SELECT SUM(e.cantidad)
                    FROM entrega e
                    WHERE e.parroquia = p.id_parroquia
                      AND e.fecha_entrega BETWEEN CURDATE() - INTERVAL 7 DAY AND CURDATE()
                ), 1)
            ), 2)
    END AS indicador_riesgo,

    -- Verificación básica de datos
    CASE 
        WHEN a.existencia IS NULL THEN 'SIN_STOCK'
        WHEN p.id_parroquia IS NULL THEN 'SIN_PARROQUIA'
        ELSE 'OK'
    END AS calidad_datos

FROM parroquia p
LEFT JOIN almacen a ON a.parroquia = p.id_parroquia

ON DUPLICATE KEY UPDATE
    consumo_7d = VALUES(consumo_7d),
    consumo_30d = VALUES(consumo_30d),
    promedio_12m = VALUES(promedio_12m),
    dias_desde_ultima_entrega = VALUES(dias_desde_ultima_entrega),
    stock_actual = VALUES(stock_actual),
    stock_capacidad = VALUES(stock_capacidad),
    solicitudes_pendientes = VALUES(solicitudes_pendientes),
    proyeccion_72h = VALUES(proyeccion_72h),
    indicador_riesgo = VALUES(indicador_riesgo),
    calidad_datos = VALUES(calidad_datos),
    updated_at = CURRENT_TIMESTAMP;
]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
2025-11-16 23:00:23,954 [INFO] Inicio de ETL de features_parroquia_daily
2025-11-16 23:00:24,046 [INFO] Usando archivo SQL: C:\xampp\htdocs\EPSDC-IA\features_diarias.sql
2025-11-16 23:00:24,071 [INFO] Longitud SQL leido: 8480 chars
2025-11-16 23:00:24,073 [ERROR] Error en ETL: (pymysql.err.ProgrammingError) (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MariaDB server version for the right syntax to use near '), 0) AS consumo_7d,\n\n    -- Total entregado últimos 30 días\n    COALESCE((...' at line 139")
[SQL: -- features_diarias.sql (adapted)
-- Compute features for each parroquia using existing schema:
--  - consumption derived from solicitud + solicitud_cilindro via vocero_consejo_comunidad->comunidad->parroquia
--  - stock attempted from almacen.litraje_total snapshot if present

INSERT INTO features_parroquia_daily (
    parroquia,
    fecha,
    consumo_7d,
    consumo_30d,
    promedio_12m,
    dias_desde_ultima_entrega,
    stock_actual,
    stock_capacidad,
    solicitudes_pendientes,
    proyeccion_72h,
    indicador_riesgo,
    calidad_datos
)
SELECT
    p.id AS parroquia,
    CURDATE() AS fecha,

    -- consumo últimos 7 días (suma de cilindros solicitados en solicitudes finalizadas/entregadas)
    COALESCE((
        SELECT SUM(sc.cantidad)
        FROM solicitud s
        JOIN solicitud_cilindro sc ON sc.solicitud_id = s.id
        JOIN vocero_comunal v ON v.cedula = s.vocero_comunal
        JOIN consejo_comunal cc ON cc.rif = v.consejo_comunal_rif
        JOIN comunidad com ON com.id = cc.comunidad_id
        WHERE com.parroquia_id = p.id
          AND s.fecha BETWEEN CURDATE() - INTERVAL 7 DAY AND CURDATE()
          AND s.estado IN ('FINALIZADA','EN ENTREGA')
    ), 0) AS consumo_7d,

    -- consumo últimos 30 días
    COALESCE((
        SELECT SUM(sc.cantidad)
        FROM solicitud s
        JOIN solicitud_cilindro sc ON sc.solicitud_id = s.id
        JOIN vocero_comunal v ON v.cedula = s.vocero_comunal
        JOIN consejo_comunal cc ON cc.rif = v.consejo_comunal_rif
        JOIN comunidad com ON com.id = cc.comunidad_id
        WHERE com.parroquia_id = p.id
          AND s.fecha BETWEEN CURDATE() - INTERVAL 30 DAY AND CURDATE()
          AND s.estado IN ('FINALIZADA','EN ENTREGA')
    ), 0) AS consumo_30d,

    -- promedio 12 meses (simple promedio de total cilindros / 12)
    COALESCE((
        SELECT SUM(sc.cantidad) / 12
        FROM solicitud s
        JOIN solicitud_cilindro sc ON sc.solicitud_id = s.id
        JOIN vocero_comunal v ON v.cedula = s.vocero_comunal
        JOIN consejo_comunal cc ON cc.rif = v.consejo_comunal_rif
        JOIN comunidad com ON com.id = cc.comunidad_id
        WHERE com.parroquia_id = p.id
          AND s.fecha BETWEEN CURDATE() - INTERVAL 12 MONTH AND CURDATE()
          AND s.estado IN ('FINALIZADA','EN ENTREGA')
    ), 0) AS promedio_12m,

    -- Días desde la última solicitud finalizada (proxy de última entrega)
    DATEDIFF(
        CURDATE(),
        COALESCE((
            SELECT MAX(s.fecha)
            FROM solicitud s
            JOIN vocero_comunal v ON v.cedula = s.vocero_comunal
            JOIN consejo_comunal cc ON cc.rif = v.consejo_comunal_rif
            JOIN comunidad com ON com.id = cc.comunidad_id
            WHERE com.parroquia_id = p.id
              AND s.estado IN ('FINALIZADA','EN ENTREGA')
        ), CURDATE())
    ) AS dias_desde_ultima_entrega,

    -- Stock: try to use almacen.litraje_total if present (may be global snapshot), else NULL
    (
        SELECT COALESCE(MAX(a.litraje_total), NULL)
        FROM almacen a
    ) AS stock_actual,
    NULL AS stock_capacidad,

    -- solicitudes pendientes (estados predefinidos)
    (
        SELECT COUNT(*)
        FROM solicitud s
        JOIN vocero_comunal v ON v.cedula = s.vocero_comunal
        JOIN consejo_comunal cc ON cc.rif = v.consejo_comunal_rif
        JOIN comunidad com ON com.id = cc.comunidad_id
        WHERE com.parroquia_id = p.id
          AND s.estado IN ('PENDIENTE','EN PROCESO','POR PAGAR','VALIDANDO')
    ) AS solicitudes_pendientes,

    -- proyección 72h (basada en promedio semanal de cilindros)
    ROUND((COALESCE((
        SELECT SUM(sc.cantidad)
        FROM solicitud s
        JOIN solicitud_cilindro sc ON sc.solicitud_id = s.id
        JOIN vocero_comunal v ON v.cedula = s.vocero_comunal
        JOIN consejo_comunal cc ON cc.rif = v.consejo_comunal_rif
        JOIN comunidad com ON com.id = cc.comunidad_id
        WHERE com.parroquia_id = p.id
          AND s.fecha BETWEEN CURDATE() - INTERVAL 7 DAY AND CURDATE()
          AND s.estado IN ('FINALIZADA','EN ENTREGA')
    ), 0) / 7) * 3, 2) AS proyeccion_72h,

    -- indicador riesgo: si no hay consumo en 7d -> 0, else NULL (no stock reliable)
    CASE WHEN (
        COALESCE((
            SELECT SUM(sc.cantidad)
            FROM solicitud s
            JOIN solicitud_cilindro sc ON sc.solicitud_id = s.id
            JOIN vocero_comunal v ON v.cedula = s.vocero_comunal
            JOIN consejo_comunal cc ON cc.rif = v.consejo_comunal_rif
            JOIN comunidad com ON com.id = cc.comunidad_id
            WHERE com.parroquia_id = p.id
              AND s.fecha BETWEEN CURDATE() - INTERVAL 7 DAY AND CURDATE()
              AND s.estado IN ('FINALIZADA','EN ENTREGA')
        ), 0) = 0) THEN 0 ELSE NULL END AS indicador_riesgo,

    -- calidad de datos básica
    CASE WHEN p.id IS NULL THEN 'SIN_PARROQUIA' ELSE 'OK' END AS calidad_datos

FROM parroquia p

ON DUPLICATE KEY UPDATE
    consumo_7d = VALUES(consumo_7d),
    consumo_30d = VALUES(consumo_30d),
    promedio_12m = VALUES(promedio_12m),
    dias_desde_ultima_entrega = VALUES(dias_desde_ultima_entrega),
    stock_actual = VALUES(stock_actual),
    stock_capacidad = VALUES(stock_capacidad),
    solicitudes_pendientes = VALUES(solicitudes_pendientes),
    proyeccion_72h = VALUES(proyeccion_72h),
    indicador_riesgo = VALUES(indicador_riesgo),
    calidad_datos = VALUES(calidad_datos),
    updated_at = CURRENT_TIMESTAMP;
    ), 0) AS consumo_7d,

    -- Total entregado últimos 30 días
    COALESCE((
        SELECT SUM(e.cantidad)
        FROM entrega e
        WHERE e.parroquia = p.id_parroquia
          AND e.fecha_entrega BETWEEN CURDATE() - INTERVAL 30 DAY AND CURDATE()
    ), 0) AS consumo_30d,

    -- Promedio mensual de los últimos 12 meses
    COALESCE((
        SELECT SUM(e.cantidad) / 12
        FROM entrega e
        WHERE e.parroquia = p.id_parroquia
          AND e.fecha_entrega BETWEEN CURDATE() - INTERVAL 12 MONTH AND CURDATE()
    ), 0) AS promedio_12m,

    -- Días desde la última entrega
    DATEDIFF(
        CURDATE(),
        COALESCE(
            (SELECT MAX(e.fecha_entrega)
             FROM entrega e
             WHERE e.parroquia = p.id_parroquia),
            CURDATE()
        )
    ) AS dias_desde_ultima_entrega,

    -- Stock actual y capacidad
    COALESCE(a.existencia, 0) AS stock_actual,
    COALESCE(a.capacidad, 0) AS stock_capacidad,

    -- Solicitudes pendientes
    (
        SELECT COUNT(*)
        FROM solicitud s
        WHERE s.parroquia = p.id_parroquia
          AND s.estado IN ('pendiente', 'en_proceso')
    ) AS solicitudes_pendientes,

    -- Proyección de consumo a 3 días (basada en promedio semanal)
    ROUND(
        (COALESCE((
            SELECT SUM(e.cantidad)
            FROM entrega e
            WHERE e.parroquia = p.id_parroquia
              AND e.fecha_entrega BETWEEN CURDATE() - INTERVAL 7 DAY AND CURDATE()
        ), 0) / 7) * 3,
        2
    ) AS proyeccion_72h,

    -- Indicador de riesgo (stock_actual / consumo semanal)
    CASE 
        WHEN COALESCE((
            SELECT SUM(e.cantidad)
            FROM entrega e
            WHERE e.parroquia = p.id_parroquia
              AND e.fecha_entrega BETWEEN CURDATE() - INTERVAL 7 DAY AND CURDATE()
        ), 0) = 0 THEN 0
        ELSE ROUND(
            a.existencia / (
                COALESCE((
                    SELECT SUM(e.cantidad)
                    FROM entrega e
                    WHERE e.parroquia = p.id_parroquia
                      AND e.fecha_entrega BETWEEN CURDATE() - INTERVAL 7 DAY AND CURDATE()
                ), 1)
            ), 2)
    END AS indicador_riesgo,

    -- Verificación básica de datos
    CASE 
        WHEN a.existencia IS NULL THEN 'SIN_STOCK'
        WHEN p.id_parroquia IS NULL THEN 'SIN_PARROQUIA'
        ELSE 'OK'
    END AS calidad_datos

FROM parroquia p
LEFT JOIN almacen a ON a.parroquia = p.id_parroquia

ON DUPLICATE KEY UPDATE
    consumo_7d = VALUES(consumo_7d),
    consumo_30d = VALUES(consumo_30d),
    promedio_12m = VALUES(promedio_12m),
    dias_desde_ultima_entrega = VALUES(dias_desde_ultima_entrega),
    stock_actual = VALUES(stock_actual),
    stock_capacidad = VALUES(stock_capacidad),
    solicitudes_pendientes = VALUES(solicitudes_pendientes),
    proyeccion_72h = VALUES(proyeccion_72h),
    indicador_riesgo = VALUES(indicador_riesgo),
    calidad_datos = VALUES(calidad_datos),
    updated_at = CURRENT_TIMESTAMP;
]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-11-16 23:03:55,732 [INFO] Inicio de ETL de features_parroquia_daily
2025-11-16 23:03:55,824 [INFO] Usando archivo SQL: C:\xampp\htdocs\EPSDC-IA\features_diarias.sql
2025-11-16 23:03:55,849 [INFO] Longitud SQL leido: 5463 chars
2025-11-16 23:03:55,860 [ERROR] Error en ETL: (pymysql.err.OperationalError) (1054, "Unknown column 'parroquia' in 'field list'")
[SQL: -- features_diarias.sql (adapted)
-- Compute features for each parroquia using existing schema:
--  - consumption derived from solicitud + solicitud_cilindro via vocero->consejo->comunidad->parroquia
--  - stock attempted from almacen.litraje_total snapshot if present

INSERT INTO features_parroquia_daily (
    parroquia,
    fecha,
    consumo_7d,
    consumo_30d,
    promedio_12m,
    dias_desde_ultima_entrega,
    stock_actual,
    stock_capacidad,
    solicitudes_pendientes,
    proyeccion_72h,
    indicador_riesgo,
    calidad_datos
)
SELECT
    p.id AS parroquia,
    CURDATE() AS fecha,

    -- consumo últimos 7 días (suma de cilindros solicitados en solicitudes finalizadas/entregadas)
    COALESCE((
        SELECT SUM(sc.cantidad)
        FROM solicitud s
        JOIN solicitud_cilindro sc ON sc.solicitud_id = s.id
        JOIN vocero_comunal v ON v.cedula = s.vocero_comunal
        JOIN consejo_comunal cc ON cc.rif = v.consejo_comunal_rif
        JOIN comunidad com ON com.id = cc.comunidad_id
        WHERE com.parroquia_id = p.id
          AND s.fecha BETWEEN CURDATE() - INTERVAL 7 DAY AND CURDATE()
          AND s.estado IN ('FINALIZADA','EN ENTREGA')
    ), 0) AS consumo_7d,

    -- consumo últimos 30 días
    COALESCE((
        SELECT SUM(sc.cantidad)
        FROM solicitud s
        JOIN solicitud_cilindro sc ON sc.solicitud_id = s.id
        JOIN vocero_comunal v ON v.cedula = s.vocero_comunal
        JOIN consejo_comunal cc ON cc.rif = v.consejo_comunal_rif
        JOIN comunidad com ON com.id = cc.comunidad_id
        WHERE com.parroquia_id = p.id
          AND s.fecha BETWEEN CURDATE() - INTERVAL 30 DAY AND CURDATE()
          AND s.estado IN ('FINALIZADA','EN ENTREGA')
    ), 0) AS consumo_30d,

    -- promedio 12 meses (simple promedio de total cilindros / 12)
    COALESCE((
        SELECT SUM(sc.cantidad) / 12
        FROM solicitud s
        JOIN solicitud_cilindro sc ON sc.solicitud_id = s.id
        JOIN vocero_comunal v ON v.cedula = s.vocero_comunal
        JOIN consejo_comunal cc ON cc.rif = v.consejo_comunal_rif
        JOIN comunidad com ON com.id = cc.comunidad_id
        WHERE com.parroquia_id = p.id
          AND s.fecha BETWEEN CURDATE() - INTERVAL 12 MONTH AND CURDATE()
          AND s.estado IN ('FINALIZADA','EN ENTREGA')
    ), 0) AS promedio_12m,

    -- Días desde la última solicitud finalizada (proxy de última entrega)
    DATEDIFF(
        CURDATE(),
        COALESCE((
            SELECT MAX(s.fecha)
            FROM solicitud s
            JOIN vocero_comunal v ON v.cedula = s.vocero_comunal
            JOIN consejo_comunal cc ON cc.rif = v.consejo_comunal_rif
            JOIN comunidad com ON com.id = cc.comunidad_id
            WHERE com.parroquia_id = p.id
              AND s.estado IN ('FINALIZADA','EN ENTREGA')
        ), CURDATE())
    ) AS dias_desde_ultima_entrega,

    -- Stock: try to use almacen.litraje_total if present (may be global snapshot), else NULL
    (
        SELECT COALESCE(MAX(a.litraje_total), NULL)
        FROM almacen a
    ) AS stock_actual,
    NULL AS stock_capacidad,

    -- solicitudes pendientes (estados predefinidos)
    (
        SELECT COUNT(*)
        FROM solicitud s
        JOIN vocero_comunal v ON v.cedula = s.vocero_comunal
        JOIN consejo_comunal cc ON cc.rif = v.consejo_comunal_rif
        JOIN comunidad com ON com.id = cc.comunidad_id
        WHERE com.parroquia_id = p.id
          AND s.estado IN ('PENDIENTE','EN PROCESO','POR PAGAR','VALIDANDO')
    ) AS solicitudes_pendientes,

    -- proyección 72h (basada en promedio semanal de cilindros)
    ROUND((COALESCE((
        SELECT SUM(sc.cantidad)
        FROM solicitud s
        JOIN solicitud_cilindro sc ON sc.solicitud_id = s.id
        JOIN vocero_comunal v ON v.cedula = s.vocero_comunal
        JOIN consejo_comunal cc ON cc.rif = v.consejo_comunal_rif
        JOIN comunidad com ON com.id = cc.comunidad_id
        WHERE com.parroquia_id = p.id
          AND s.fecha BETWEEN CURDATE() - INTERVAL 7 DAY AND CURDATE()
          AND s.estado IN ('FINALIZADA','EN ENTREGA')
    ), 0) / 7) * 3, 2) AS proyeccion_72h,

    -- indicador riesgo: si no hay consumo en 7d -> 0, else NULL (no stock reliable)
    CASE WHEN (
        COALESCE((
            SELECT SUM(sc.cantidad)
            FROM solicitud s
            JOIN solicitud_cilindro sc ON sc.solicitud_id = s.id
            JOIN vocero_comunal v ON v.cedula = s.vocero_comunal
            JOIN consejo_comunal cc ON cc.rif = v.consejo_comunal_rif
            JOIN comunidad com ON com.id = cc.comunidad_id
            WHERE com.parroquia_id = p.id
              AND s.fecha BETWEEN CURDATE() - INTERVAL 7 DAY AND CURDATE()
              AND s.estado IN ('FINALIZADA','EN ENTREGA')
        ), 0) = 0) THEN 0 ELSE NULL END AS indicador_riesgo,

    -- calidad de datos básica
    CASE WHEN p.id IS NULL THEN 'SIN_PARROQUIA' ELSE 'OK' END AS calidad_datos

FROM parroquia p

ON DUPLICATE KEY UPDATE
    consumo_7d = VALUES(consumo_7d),
    consumo_30d = VALUES(consumo_30d),
    promedio_12m = VALUES(promedio_12m),
    dias_desde_ultima_entrega = VALUES(dias_desde_ultima_entrega),
    stock_actual = VALUES(stock_actual),
    stock_capacidad = VALUES(stock_capacidad),
    solicitudes_pendientes = VALUES(solicitudes_pendientes),
    proyeccion_72h = VALUES(proyeccion_72h),
    indicador_riesgo = VALUES(indicador_riesgo),
    calidad_datos = VALUES(calidad_datos),
    updated_at = CURRENT_TIMESTAMP;
]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
2025-11-16 23:08:01,083 [INFO] Inicio de ETL de features_parroquia_daily
2025-11-16 23:08:01,168 [INFO] Usando archivo SQL: C:\xampp\htdocs\EPSDC-IA\features_diarias.sql
2025-11-16 23:08:01,191 [INFO] Longitud SQL leido: 5469 chars
2025-11-16 23:08:01,193 [ERROR] Error en ETL: (pymysql.err.OperationalError) (1054, "Unknown column 'stock_capacidad' in 'field list'")
[SQL: -- features_diarias.sql (adapted)
-- Compute features for each parroquia using existing schema:
--  - consumption derived from solicitud + solicitud_cilindro via vocero->consejo->comunidad->parroquia
--  - stock attempted from almacen.litraje_total snapshot if present

INSERT INTO features_parroquia_daily (
    parroquia_id,
    fecha,
    consumo_7d,
    consumo_30d,
    promedio_12m,
    dias_desde_ultima_entrega,
    stock_actual,
    stock_capacidad,
    solicitudes_pendientes,
    proyeccion_72h,
    indicador_riesgo,
    calidad_datos
)
SELECT
    p.id AS parroquia_id,
    CURDATE() AS fecha,

    -- consumo últimos 7 días (suma de cilindros solicitados en solicitudes finalizadas/entregadas)
    COALESCE((
        SELECT SUM(sc.cantidad)
        FROM solicitud s
        JOIN solicitud_cilindro sc ON sc.solicitud_id = s.id
        JOIN vocero_comunal v ON v.cedula = s.vocero_comunal
        JOIN consejo_comunal cc ON cc.rif = v.consejo_comunal_rif
        JOIN comunidad com ON com.id = cc.comunidad_id
        WHERE com.parroquia_id = p.id
          AND s.fecha BETWEEN CURDATE() - INTERVAL 7 DAY AND CURDATE()
          AND s.estado IN ('FINALIZADA','EN ENTREGA')
    ), 0) AS consumo_7d,

    -- consumo últimos 30 días
    COALESCE((
        SELECT SUM(sc.cantidad)
        FROM solicitud s
        JOIN solicitud_cilindro sc ON sc.solicitud_id = s.id
        JOIN vocero_comunal v ON v.cedula = s.vocero_comunal
        JOIN consejo_comunal cc ON cc.rif = v.consejo_comunal_rif
        JOIN comunidad com ON com.id = cc.comunidad_id
        WHERE com.parroquia_id = p.id
          AND s.fecha BETWEEN CURDATE() - INTERVAL 30 DAY AND CURDATE()
          AND s.estado IN ('FINALIZADA','EN ENTREGA')
    ), 0) AS consumo_30d,

    -- promedio 12 meses (simple promedio de total cilindros / 12)
    COALESCE((
        SELECT SUM(sc.cantidad) / 12
        FROM solicitud s
        JOIN solicitud_cilindro sc ON sc.solicitud_id = s.id
        JOIN vocero_comunal v ON v.cedula = s.vocero_comunal
        JOIN consejo_comunal cc ON cc.rif = v.consejo_comunal_rif
        JOIN comunidad com ON com.id = cc.comunidad_id
        WHERE com.parroquia_id = p.id
          AND s.fecha BETWEEN CURDATE() - INTERVAL 12 MONTH AND CURDATE()
          AND s.estado IN ('FINALIZADA','EN ENTREGA')
    ), 0) AS promedio_12m,

    -- Días desde la última solicitud finalizada (proxy de última entrega)
    DATEDIFF(
        CURDATE(),
        COALESCE((
            SELECT MAX(s.fecha)
            FROM solicitud s
            JOIN vocero_comunal v ON v.cedula = s.vocero_comunal
            JOIN consejo_comunal cc ON cc.rif = v.consejo_comunal_rif
            JOIN comunidad com ON com.id = cc.comunidad_id
            WHERE com.parroquia_id = p.id
              AND s.estado IN ('FINALIZADA','EN ENTREGA')
        ), CURDATE())
    ) AS dias_desde_ultima_entrega,

    -- Stock: try to use almacen.litraje_total if present (may be global snapshot), else NULL
    (
        SELECT COALESCE(MAX(a.litraje_total), NULL)
        FROM almacen a
    ) AS stock_actual,
    NULL AS stock_capacidad,

    -- solicitudes pendientes (estados predefinidos)
    (
        SELECT COUNT(*)
        FROM solicitud s
        JOIN vocero_comunal v ON v.cedula = s.vocero_comunal
        JOIN consejo_comunal cc ON cc.rif = v.consejo_comunal_rif
        JOIN comunidad com ON com.id = cc.comunidad_id
        WHERE com.parroquia_id = p.id
          AND s.estado IN ('PENDIENTE','EN PROCESO','POR PAGAR','VALIDANDO')
    ) AS solicitudes_pendientes,

    -- proyección 72h (basada en promedio semanal de cilindros)
    ROUND((COALESCE((
        SELECT SUM(sc.cantidad)
        FROM solicitud s
        JOIN solicitud_cilindro sc ON sc.solicitud_id = s.id
        JOIN vocero_comunal v ON v.cedula = s.vocero_comunal
        JOIN consejo_comunal cc ON cc.rif = v.consejo_comunal_rif
        JOIN comunidad com ON com.id = cc.comunidad_id
        WHERE com.parroquia_id = p.id
          AND s.fecha BETWEEN CURDATE() - INTERVAL 7 DAY AND CURDATE()
          AND s.estado IN ('FINALIZADA','EN ENTREGA')
    ), 0) / 7) * 3, 2) AS proyeccion_72h,

    -- indicador riesgo: si no hay consumo en 7d -> 0, else NULL (no stock reliable)
    CASE WHEN (
        COALESCE((
            SELECT SUM(sc.cantidad)
            FROM solicitud s
            JOIN solicitud_cilindro sc ON sc.solicitud_id = s.id
            JOIN vocero_comunal v ON v.cedula = s.vocero_comunal
            JOIN consejo_comunal cc ON cc.rif = v.consejo_comunal_rif
            JOIN comunidad com ON com.id = cc.comunidad_id
            WHERE com.parroquia_id = p.id
              AND s.fecha BETWEEN CURDATE() - INTERVAL 7 DAY AND CURDATE()
              AND s.estado IN ('FINALIZADA','EN ENTREGA')
        ), 0) = 0) THEN 0 ELSE NULL END AS indicador_riesgo,

    -- calidad de datos básica
    CASE WHEN p.id IS NULL THEN 'SIN_PARROQUIA' ELSE 'OK' END AS calidad_datos

FROM parroquia p

ON DUPLICATE KEY UPDATE
    consumo_7d = VALUES(consumo_7d),
    consumo_30d = VALUES(consumo_30d),
    promedio_12m = VALUES(promedio_12m),
    dias_desde_ultima_entrega = VALUES(dias_desde_ultima_entrega),
    stock_actual = VALUES(stock_actual),
    stock_capacidad = VALUES(stock_capacidad),
    solicitudes_pendientes = VALUES(solicitudes_pendientes),
    proyeccion_72h = VALUES(proyeccion_72h),
    indicador_riesgo = VALUES(indicador_riesgo),
    calidad_datos = VALUES(calidad_datos),
    updated_at = CURRENT_TIMESTAMP;
]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
2025-11-16 23:08:39,263 [INFO] Inicio de ETL de features_parroquia_daily
2025-11-16 23:08:39,353 [INFO] Usando archivo SQL: C:\xampp\htdocs\EPSDC-IA\features_diarias.sql
2025-11-16 23:08:39,376 [INFO] Longitud SQL leido: 5445 chars
2025-11-16 23:08:39,455 [INFO] ETL completado correctamente para 2025-11-16
2025-11-16 23:51:50,839 [INFO] Inicio de ETL de features_parroquia_daily
2025-11-16 23:51:50,885 [INFO] Usando archivo SQL: C:\xampp\htdocs\EPSDC-IA\features_diarias.sql
2025-11-16 23:51:50,906 [INFO] Longitud SQL leido: 5445 chars
2025-11-16 23:51:50,997 [INFO] ETL completado correctamente para 2025-11-16
2025-11-16 23:59:00,113 [INFO] Inicio de ETL de features_parroquia_daily
2025-11-16 23:59:00,158 [INFO] Usando archivo SQL: C:\xampp\htdocs\EPSDC-IA\features_diarias.sql
2025-11-16 23:59:00,170 [INFO] Longitud SQL leido: 5445 chars
2025-11-16 23:59:00,267 [INFO] ETL completado correctamente para 2025-11-16
2025-11-17 01:37:07,278 [ERROR] Error en /api/v1/recommendations
Traceback (most recent call last):
  File "C:\xampp\htdocs\EPSDC-IA\main.py", line 47, in predict
    result = predict_from_dict(data.dict())
  File "C:\xampp\htdocs\EPSDC-IA\model_loader.py", line 32, in predict_from_dict
    pred = model.predict(df)[0]
           ~~~~~~~~~~~~~^^^^
  File "C:\Users\Usuario\AppData\Local\Programs\Python\Python313\Lib\site-packages\sklearn\tree\_classes.py", line 530, in predict
    X = self._validate_X_predict(X, check_input)
  File "C:\Users\Usuario\AppData\Local\Programs\Python\Python313\Lib\site-packages\sklearn\tree\_classes.py", line 489, in _validate_X_predict
    X = validate_data(
        self,
    ...<4 lines>...
        ensure_all_finite=ensure_all_finite,
    )
  File "C:\Users\Usuario\AppData\Local\Programs\Python\Python313\Lib\site-packages\sklearn\utils\validation.py", line 2929, in validate_data
    _check_feature_names(_estimator, X, reset=reset)
    ~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Usuario\AppData\Local\Programs\Python\Python313\Lib\site-packages\sklearn\utils\validation.py", line 2787, in _check_feature_names
    raise ValueError(message)
ValueError: The feature names should match those that were passed during fit.
Feature names unseen at fit time:
- solicitudes_pendientes
- stock_capacidad
Feature names seen at fit time, yet now missing:
- entregas_pendientes
- parroquia

2025-11-17 01:37:24,682 [ERROR] Error en /api/v1/recommendations
Traceback (most recent call last):
  File "C:\xampp\htdocs\EPSDC-IA\main.py", line 47, in predict
    result = predict_from_dict(data.dict())
  File "C:\xampp\htdocs\EPSDC-IA\model_loader.py", line 32, in predict_from_dict
    pred = model.predict(df)[0]
           ~~~~~~~~~~~~~^^^^
  File "C:\Users\Usuario\AppData\Local\Programs\Python\Python313\Lib\site-packages\sklearn\tree\_classes.py", line 530, in predict
    X = self._validate_X_predict(X, check_input)
  File "C:\Users\Usuario\AppData\Local\Programs\Python\Python313\Lib\site-packages\sklearn\tree\_classes.py", line 489, in _validate_X_predict
    X = validate_data(
        self,
    ...<4 lines>...
        ensure_all_finite=ensure_all_finite,
    )
  File "C:\Users\Usuario\AppData\Local\Programs\Python\Python313\Lib\site-packages\sklearn\utils\validation.py", line 2929, in validate_data
    _check_feature_names(_estimator, X, reset=reset)
    ~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Usuario\AppData\Local\Programs\Python\Python313\Lib\site-packages\sklearn\utils\validation.py", line 2787, in _check_feature_names
    raise ValueError(message)
ValueError: The feature names should match those that were passed during fit.
Feature names unseen at fit time:
- solicitudes_pendientes
- stock_capacidad
Feature names seen at fit time, yet now missing:
- entregas_pendientes
- parroquia

